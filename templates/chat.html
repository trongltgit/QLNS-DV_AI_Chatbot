{% extends "base.html" %}
{% block title %}Chatbot{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 offset-md-2">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5>Chatbot (RAG + LLM fallback)</h5>
                <div id="chatbox" style="height:400px; overflow:auto; border:1px solid #eee; padding:10px; background:#fff;">
                    <div class="text-muted">Nhập câu hỏi ở ô bên dưới và nhấn Gửi.</div>
                </div>

                <div class="input-group mt-3">
                    <input id="message" class="form-control" placeholder="Nhập câu hỏi..." />
                    <button id="sendBtn" class="btn btn-primary">Gửi</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById("sendBtn").addEventListener("click", sendMessage);
document.getElementById("message").addEventListener("keydown", function(e){
    if(e.key === "Enter") sendMessage();
});

async function sendMessage(){
    const input = document.getElementById("message");
    const text = input.value.trim();
    if(!text) return;
    appendChat("Bạn", text);
    input.value = "";
    try {
        const res = await fetch("/chat", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({message: text})
        });
        const data = await res.json();
        appendChat("Bot", data.reply || "Không có phản hồi.");
    } catch(err) {
        appendChat("Bot", "Lỗi kết nối đến server.");
    }
}

function appendChat(who, text){
    const box = document.getElementById("chatbox");
    const p = document.createElement("div");
    p.innerHTML = `<strong>${who}:</strong> <div style="margin-top:4px">${text}</div><hr/>`;
    box.appendChild(p);
    box.scrollTop = box.scrollHeight;
}
</script>
{% endblock %}
