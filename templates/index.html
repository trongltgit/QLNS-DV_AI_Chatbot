{% extends "base.html" %}
{% block title %}Chatbot AI - Hỏi đáp tài liệu Đảng{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-xl-10">

    <!-- Upload -->
    <div class="card mb-4 border-0 shadow-lg">
      <div class="card-header bg-danger text-white py-3">
        <h4 class="mb-0"><i class="fas fa-cloud-upload-alt"></i> Upload Tài liệu Đảng (PDF, DOCX, TXT, XLSX)</h4>
      </div>
      <div class="card-body">
        <form id="uploadForm">
          <div class="input-group input-group-lg">
            <input type="file" id="fileInput" class="form-control" accept=".pdf,.txt,.docx,.xlsx" required>
            <button type="submit" class="btn btn-danger">Upload & Tóm tắt</button>
          </div>
        </form>
        <div id="uploadResponse" class="mt-4"></div>
      </div>
    </div>

    <!-- Chat -->
    <div class="card border-0 shadow-lg">
      <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center py-3">
        <h4 class="mb-0"><i class="fas fa-robot"></i> Chatbot AI - Hỏi đáp dựa trên tài liệu</h4>
        <button id="clearChat" class="btn btn-outline-light btn-sm rounded-pill">
          <i class="fas fa-trash-alt"></i> Xóa lịch sử
        </button>
      </div>
      <div class="card-body p-0">
        <div id="chatContainer" style="height: 580px; overflow-y: auto; padding: 20px; background: #f8f9fa;"></div>
        <form id="chatForm" class="p-3 border-top bg-white">
          <div class="input-group">
            <input type="text" id="prompt" class="form-control form-control-lg border-danger" 
                   placeholder="Ví dụ: Điều 4 Điều lệ Đảng quy định thế nào? Sinh hoạt chi bộ tháng này ra sao?" required>
            <button type="submit" class="btn btn-danger btn-lg px-4">Gửi</button>
          </div>
        </form>
      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const BASE_URL = location.origin + "/";
  const uploadForm = document.getElementById("uploadForm");
  const fileInput = document.getElementById("fileInput");
  const uploadResponse = document.getElementById("uploadResponse");
  const chatContainer = document.getElementById("chatContainer");
  const chatForm = document.getElementById("chatForm");
  const promptInput = document.getElementById("prompt");
  const clearChatBtn = document.getElementById("clearChat");

  let currentFilename = null;
  let chatHistory = JSON.parse(localStorage.getItem('chatHistory') || '[]');
  let isProcessing = false;

  renderChatHistory();

  uploadForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    if (!fileInput.files.length) return;
    const file = fileInput.files[0];
    const formData = new FormData();
    formData.append("file", file);
    uploadResponse.innerHTML = `<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> Đang xử lý tài liệu...</div>`;

    try {
      const res = await fetch(`${BASE_URL}upload`, { method: "POST", body: formData });
      const data = await res.json();
      if (data.filename) {
        currentFilename = data.filename;
        uploadResponse.innerHTML = `
          <div class="alert alert-success border-start border-success border-5">
            <h5>Upload thành công: ${data.filename}</h5>
            <strong>Tóm tắt tài liệu:</strong><br>
            <div class="mt-2 p-3 bg-light rounded">${data.summary.replace(/\n/g, '<br>')}</div>
          </div>`;
        chatHistory = []; localStorage.setItem('chatHistory', '[]'); renderChatHistory();
      } else {
        uploadResponse.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
      }
    } catch (err) {
      uploadResponse.innerHTML = `<div class="alert alert-danger">Lỗi: ${err.message}</div>`;
    }
  });

  chatForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const prompt = promptInput.value.trim();
    if (!prompt || isProcessing) return;

    addMessage(prompt, 'user');
    promptInput.value = ''; isProcessing = true;
    addMessage('Đang suy nghĩ...', 'ai');

    try {
      const formData = new FormData();
      formData.append("prompt", prompt);
      if (currentFilename) formData.append("context_filename", currentFilename);
      formData.append("history", JSON.stringify(chatHistory));

      const res = await fetch(`${BASE_URL}chat`, { method: "POST", body: formData });
      const data = await res.json();

      chatContainer.removeChild(chatContainer.lastElementChild);
      if (data.response) {
        addMessage(data.response, 'ai');
        chatHistory = data.updated_history ? JSON.parse(data.updated_history) : chatHistory;
        localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
      } else {
        addMessage(`Lỗi: ${data.error}`, 'ai');
      }
    } catch (err) {
      chatContainer.removeChild(chatContainer.lastElementChild);
      addMessage(`Lỗi kết nối: ${err.message}`, 'ai');
    }
    isProcessing = false;
    chatContainer.scrollTop = chatContainer.scrollHeight;
  });

  clearChatBtn.addEventListener("click", () => {
    if (confirm("Xóa toàn bộ lịch sử trò chuyện?")) {
      chatHistory = []; localStorage.removeItem('chatHistory'); chatContainer.innerHTML = ''; 
    }
  });

  function addMessage(text, sender) {
    const bubble = document.createElement('div');
    bubble.className = `mb-4 d-flex ${sender === 'user' ? 'justify-content-end' : 'justify-content-start'}`;
    bubble.innerHTML = `
      <div class="p-3 rounded-4 shadow-sm ${sender === 'user' ? 'bg-danger text-white' : 'bg-light text-dark'}"
           style="max-width: 80%; word-wrap: break-word;">
        ${text.replace(/\n/g, '<br>')}
      </div>`;
    chatContainer.appendChild(bubble);
    chatContainer.scrollTop = chatContainer.scrollHeight;
  }

  function renderChatHistory() {
    chatContainer.innerHTML = '';
    chatHistory.forEach(m => addMessage(m.content, m.role === 'user' ? 'user' : 'ai'));
  }
</script>
{% endblock %}
