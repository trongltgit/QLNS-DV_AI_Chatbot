{% extends "base.html" %}
{% block title %}Chatbot AI - Hỏi đáp tài liệu Đảng{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-xl-10">

    <!-- Upload -->
    <div class="card mb-4 border-0 shadow-lg">
      <div class="card-header bg-danger text-white py-3">
        <h4 class="mb-0"><i class="fas fa-cloud-upload-alt"></i> Upload Tài liệu Đảng (PDF, DOCX, TXT, XLSX)</h4>
      </div>
      <div class="card-body">
        <form id="uploadForm">
          <div class="input-group input-group-lg">
            <input type="file" id="fileInput" class="form-control" accept=".pdf,.txt,.docx,.xlsx" required>
            <button type="submit" class="btn btn-danger">Upload & Tóm tắt</button>
          </div>
        </form>
        <div id="uploadResponse" class="mt-4"></div>
      </div>
    </div>

    <!-- Chat -->
    <div class="card border-0 shadow-lg">
      <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center py-3">
        <h4 class="mb-0"><i class="fas fa-robot"></i> Chatbot AI - Hỏi đáp dựa trên tài liệu</h4>
        <button id="clearChat" class="btn btn-outline-light btn-sm rounded-pill">
          <i class="fas fa-trash-alt"></i> Xóa lịch sử
        </button>
      </div>
      <div class="card-body p-0">
        <div id="chatContainer" style="height: 580px; overflow-y: auto; padding: 20px; background: #f8f9fa;"></div>
        <form id="chatForm" class="p-3 border-top bg-white">
          <div class="input-group">
            <input type="text" id="prompt" class="form-control form-control-lg border-danger" 
                   placeholder="Ví dụ: Điều 4 Điều lệ Đảng quy định thế nào? Sinh hoạt chi bộ tháng này ra sao?" required>
            <button type="submit" class="btn btn-danger btn-lg px-4">Gửi</button>
          </div>
        </form>
      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let chatHistory = [];

function addMessage(text, sender) {
  const chatBox = document.getElementById("chatBox");
  const div = document.createElement("div");
  div.className = `message ${sender}-message`;
  div.innerHTML = `<p>${text.replace(/\n/g, '<br>')}</p>`;
  chatBox.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;
}

document.getElementById("chatForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const input = document.getElementById("promptInput");
  const prompt = input.value.trim();
  if (!prompt) return;
  
  addMessage(prompt, "user");
  input.value = "";
  
  const response = await fetch("/chat", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: new URLSearchParams({
      "prompt": prompt,
      "history": JSON.stringify(chatHistory)
    })
  });
  
  const data = await response.json();
  addMessage(data.response, "ai");
  chatHistory = JSON.parse(data.updated_history || "[]");
});
</script>
{% endblock %}
