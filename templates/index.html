{% extends "base.html" %}
{% block title %}Chatbot AI{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-xl-10">
    <!-- Upload -->
    <div class="card mb-4 border-0 shadow-lg">
      <div class="card-header bg-danger text-white py-3">
        <h4 class="mb-0"><i class="fas fa-cloud-upload-alt"></i> Upload Tài liệu Đảng</h4>
      </div>
      <div class="card-body">
        <form id="uploadForm" enctype="multipart/form-data">
          <div class="input-group">
            <input type="file" id="fileInput" class="form-control" accept=".pdf,.docx,.txt,.xlsx" required>
            <button type="submit" class="btn btn-danger">Upload & Tóm tắt</button>
          </div>
        </form>
        <div id="uploadResponse" class="mt-3"></div>
      </div>
    </div>

    <!-- Chat -->
    <div class="card border-0 shadow-lg">
      <div class="card-header bg-danger text-white d-flex justify-content-between py-3">
        <h4 class="mb-0"><i class="fas fa-robot"></i> Chatbot AI</h4>
        <button id="clearChat" class="btn btn-outline-light btn-sm">Xóa lịch sử</button>
      </div>
      <div class="card-body p-0">
        <div id="chatContainer" class="p-3" style="height: 400px; overflow-y: auto; background: #f8f9fa;">
          <div class="text-center text-muted py-3">Upload tài liệu rồi chat nhé!</div>
        </div>
        <form id="chatForm" class="p-3 border-top bg-white">
          <div class="input-group">
            <input type="text" id="prompt" class="form-control" placeholder="Hỏi về tài liệu...">
            <button type="submit" class="btn btn-danger">Gửi</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let chatHistory = [];
const chatContainer = document.getElementById('chatContainer');
const uploadForm = document.getElementById('uploadForm');
const fileInput = document.getElementById('fileInput');
const uploadResponse = document.getElementById('uploadResponse');
const chatForm = document.getElementById('chatForm');
const promptInput = document.getElementById('prompt');
const clearBtn = document.getElementById('clearChat');

function addMessage(text, sender) {
  const div = document.createElement('div');
  div.className = `mb-3 ${sender === 'user' ? 'text-end' : 'text-start'}`;
  div.innerHTML = `<div class="d-inline-block p-2 rounded ${sender === 'user' ? 'bg-danger text-white' : 'bg-light'}">${text.replace(/\n/g, '<br>')}</div>`;
  chatContainer.appendChild(div);
  chatContainer.scrollTop = chatContainer.scrollHeight;
  if (sender === 'ai' && chatHistory.length === 0) chatContainer.innerHTML = '';  // Xóa placeholder
}

uploadForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  if (!fileInput.files[0]) {
    uploadResponse.innerHTML = '<div class="alert alert-warning">Chọn file trước!</div>';
    return;
  }
  const formData = new FormData();
  formData.append('file', fileInput.files[0]);
  uploadResponse.innerHTML = '<div class="alert alert-info">Đang upload...</div>';

  try {
    const res = await fetch('/upload', { method: 'POST', body: formData });
    const data = await res.json();
    if (data.error) {
      uploadResponse.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
    } else {
      uploadResponse.innerHTML = `
        <div class="alert alert-success">
          <strong>${data.filename}</strong><br>
          <strong>Tóm tắt:</strong> ${data.summary.replace(/\n/g, '<br>')}
        </div>`;
      chatHistory = [];  // Reset chat sau upload
      addMessage('Tài liệu đã upload! Bắt đầu chat nhé.', 'ai');
    }
  } catch (err) {
    uploadResponse.innerHTML = `<div class="alert alert-danger">Lỗi: ${err.message}</div>`;
  }
});

chatForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  const prompt = promptInput.value.trim();
  if (!prompt) return;
  addMessage(prompt, 'user');
  promptInput.value = '';
  addMessage('Đang suy nghĩ...', 'ai');

  try {
    const formData = new FormData();
    formData.append('prompt', prompt);
    formData.append('history', JSON.stringify(chatHistory));
    const res = await fetch('/chat', { method: 'POST', body: formData });
    const data = await res.json();
    chatContainer.lastElementChild.remove();  // Xóa "Đang suy nghĩ..."
    addMessage(data.response, 'ai');
    chatHistory = JSON.parse(data.updated_history || '[]');
  } catch (err) {
    chatContainer.lastElementChild.remove();
    addMessage('Lỗi kết nối, thử lại nhé!', 'ai');
  }
});

clearBtn.addEventListener('click', () => {
  if (confirm('Xóa lịch sử chat?')) {
    chatContainer.innerHTML = '<div class="text-center text-muted py-3">Lịch sử đã xóa!</div>';
    chatHistory = [];
  }
});
</script>
{% endblock %}
