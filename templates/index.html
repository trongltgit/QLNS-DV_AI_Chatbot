<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AI Chat & File Upload Demo</title>
  <style>
    body { font-family: Arial; background: #f4f6f9; margin:0; padding:0; display:flex; flex-direction:column; min-height:100vh; }
    header { background: #2c7a7b; color:white; padding:1rem; text-align:center; }
    main { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:flex-start; padding:2rem; gap:2rem; }
    .section { width:100%; max-width:600px; background:white; padding:1.5rem; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1);}
    h2 { margin-top:0; }
    form { display:flex; flex-direction:column; gap:10px; }
    input[type="text"], input[type="file"] { padding:10px; font-size:16px; border:1px solid #ccc; border-radius:8px; }
    select { padding:10px; font-size:16px; border:1px solid #ccc; border-radius:8px; }
    button { padding:10px 20px; font-size:16px; background:#2c7a7b; color:white; border:none; border-radius:8px; cursor:pointer; }
    button:hover { background:#285e61; }
    #chatResponse, #uploadResponse { margin-top:15px; padding:15px; background:#f9f9f9; border-radius:8px; border:1px solid #ddd; white-space: pre-wrap;}
  </style>
</head>
<body>
  <header><h1>AI Chat & File Upload Demo</h1></header>
  <main>
    <div class="section">
      <h2>Upload File</h2>
      <form id="uploadForm">
        <input type="file" id="fileInput" accept=".txt,.pdf,.docx" required />
        <button type="submit">Upload</button>
      </form>
      <div id="uploadResponse"></div>
    </div>

    <div class="section">
      <h2>Chat with AI</h2>
      <select id="fileSelect">
        <option value="">-- Chọn file đã upload --</option>
      </select>
      <form id="chatForm">
        <input type="text" id="prompt" placeholder="Nhập câu hỏi của bạn..." required />
        <button type="submit">Gửi</button>
      </form>
      <div id="chatResponse"></div>
    </div>
  </main>

  <script>
    const uploadForm = document.getElementById("uploadForm");
    const fileInput = document.getElementById("fileInput");
    const uploadResponse = document.getElementById("uploadResponse");
    const fileSelect = document.getElementById("fileSelect");

    uploadForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!fileInput.files.length) return;
      const file = fileInput.files[0];
      const formData = new FormData();
      formData.append("file", file);
      uploadResponse.textContent = "Đang upload...";
      try {
        const res = await fetch("/upload", { method: "POST", body: formData });
        const data = await res.json();
        if (data.filename) {
          uploadResponse.textContent = `✅ Upload thành công: ${data.filename}\nTóm tắt: ${data.summary}`;
          // Thêm file vào select
          const option = document.createElement("option");
          option.value = data.filename;
          option.textContent = data.filename;
          fileSelect.appendChild(option);
        } else if (data.error) {
          uploadResponse.textContent = `❌ Lỗi: ${data.error}`;
        }
      } catch(err) { uploadResponse.textContent = `❌ Lỗi server: ${err.message}`; }
    });

    const chatForm = document.getElementById("chatForm");
    const promptInput = document.getElementById("prompt");
    const chatResponse = document.getElementById("chatResponse");

    chatForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const filename = fileSelect.value;
      if(!filename){ chatResponse.textContent="❌ Chọn file trước khi chat"; return; }
      chatResponse.textContent = "Đang xử lý...";
      const formData = new FormData();
      formData.append("prompt", promptInput.value);
      formData.append("filename", filename);
      try {
        const res = await fetch("/chat", { method:"POST", body:formData });
        const data = await res.json();
        if(data.response) chatResponse.textContent = data.response;
        else if(data.error) chatResponse.textContent = `❌ Lỗi: ${data.error}`;
      } catch(err){ chatResponse.textContent = `❌ Lỗi server: ${err.message}`; }
    });
  </script>
</body>
</html>
